<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irish Property Price Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="model.js"></script>
    <script src="features.js"></script>
    <script src="stats.js"></script>
</head>
<body class="bg-gradient-to-br from-emerald-50 to-teal-100 min-h-screen py-8 px-4">
    <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-emerald-800 mb-2">üè° Irish Property Price Predictor</h1>
                <p class="text-gray-600">Guess residential property sale prices in Ireland</p>
            </div>

            <form id="predictForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="eircode" class="block text-sm font-semibold text-gray-700 mb-2">
                            First 3 characters of Eircode
                        </label>
                        <input
                            type="text"
                            id="eircode"
                            name="eircode_routing_key"
                            maxlength="3"
                            pattern="[A-Za-z0-9]{3}"
                            placeholder="e.g., D02"
                            value="D08"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition uppercase"
                            required
                        >
                    </div>

                    <div>
                        <label for="sale_date" class="block text-sm font-semibold text-gray-700 mb-2">
                            Sell
                        </label>
                        <select
                            id="sale_date"
                            name="sale_date"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition bg-white"
                            required
                        >
                            <option value="0" selected>Today</option>
                            <option value="3">3 months</option>
                            <option value="6">6 months</option>
                            <option value="12">1 year</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="bedrooms" class="block text-sm font-semibold text-gray-700 mb-2">
                            Bedrooms
                        </label>
                        <input
                            type="number"
                            id="bedrooms"
                            name="bedrooms"
                            min="1"
                            max="20"
                            placeholder="e.g., 3"
                            value="3"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition"
                            required
                        >
                    </div>

                    <div>
                        <label for="bathrooms" class="block text-sm font-semibold text-gray-700 mb-2">
                            Bathrooms
                        </label>
                        <input
                            type="number"
                            id="bathrooms"
                            name="bathrooms"
                            min="1"
                            max="10"
                            placeholder="e.g., 2"
                            value="2"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition"
                            required
                        >
                    </div>
                </div>

                <div>
                    <label for="size_m" class="block text-sm font-semibold text-gray-700 mb-2">
                        Size (square metres)
                    </label>
                    <input
                        type="number"
                        id="size_m"
                        name="size_m"
                        min="10"
                        max="10000"
                        step="0.1"
                        placeholder="e.g., 120"
                        value="85"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition"
                        required
                    >
                </div>

                <div>
                    <label for="building_type" class="block text-sm font-semibold text-gray-700 mb-2">
                        Building Type
                    </label>
                    <select
                        id="building_type"
                        name="building_type"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition bg-white"
                        required
                    >
                        <option value="">Select building type...</option>
                        <option value="apartment">Apartment</option>
                        <option value="terraced" selected>Terraced</option>
                        <option value="semi_detached">Semi-Detached</option>
                        <option value="detached">Detached</option>
                    </select>
                </div>

                <div>
                    <label for="ber_rating" class="block text-sm font-semibold text-gray-700 mb-2">
                        BER Rating
                    </label>
                    <select
                        id="ber_rating"
                        name="ber_rating"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition bg-white"
                        required
                    >
                        <option value="">Select BER rating...</option>
                        <option value="A1">A1 (Best)</option>
                        <option value="A2">A2</option>
                        <option value="A3">A3</option>
                        <option value="B1">B1</option>
                        <option value="B2">B2</option>
                        <option value="B3">B3</option>
                        <option value="C1" selected>C1</option>
                        <option value="C2">C2</option>
                        <option value="C3">C3</option>
                        <option value="D1">D1</option>
                        <option value="D2">D2</option>
                        <option value="E1">E1</option>
                        <option value="E2">E2</option>
                        <option value="F">F</option>
                        <option value="G">G (Worst)</option>
                    </select>
                </div>

                <button
                    type="submit"
                    class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-bold py-4 px-6 rounded-lg hover:from-emerald-700 hover:to-teal-700 transform transition hover:scale-105 shadow-lg"
                >
                    Predict Sale Price
                </button>
            </form>

            <div id="result" class="mt-8 hidden">
                <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border-l-4 border-emerald-500 p-6 rounded-lg">
                    <h2 class="text-xl font-bold text-emerald-800 mb-2">Estimated Sale Price</h2>
                    <p class="text-4xl font-bold text-emerald-600" id="predictedPrice">‚Ç¨0</p>
                    <p class="text-sm text-gray-600 mt-2">This is an estimate based on historical data and extrapolated trends</p>
                </div>
            </div>

            <div id="error" class="mt-8 hidden">
                <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg">
                    <h2 class="text-xl font-bold text-red-800 mb-2">Error</h2>
                    <p class="text-red-600" id="errorMessage"></p>
                </div>
            </div>

            <div class="mt-8">
                <h2 class="text-xl font-bold text-emerald-800 mb-4">Eircode Location Impact</h2>
                <p class="text-sm text-gray-600 mb-4">Average price adjustment by eircode (all else being equal)</p>
                <div class="overflow-x-auto max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Rank</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Eircode</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Impact</th>
                            </tr>
                        </thead>
                        <tbody id="eircodeTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="mt-6 text-center text-gray-600 text-sm">
            <p>Powered by <span class="relative inline-block group">
                <span class="cursor-help border-b border-dotted border-gray-400">XGBoost machine learning model</span>
                <span class="invisible group-hover:visible absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-4 py-3 bg-gray-900 text-white text-xs rounded-lg shadow-lg whitespace-nowrap z-10">
                    <span class="block font-semibold mb-1">Model Performance</span>
                    <span class="block">R¬≤ Score: <span id="r2-value"></span></span>
                    <span class="block">Training Dataset: <span id="train-size"></span> properties</span>
                    <span class="block mt-1 text-gray-300 max-w-xs whitespace-normal">The model explains <span id="r2-percent"></span> of price variance</span>
                    <span class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1 border-4 border-transparent border-t-gray-900"></span>
                </span>
            </span> running entirely in your browser</p>
            <p class="mt-1">No data is sent to any server - completely private</p>
        </div>
    </div>

    <script>
        const form = document.getElementById('predictForm');
        const resultDiv = document.getElementById('result');
        const errorDiv = document.getElementById('error');
        const predictedPriceEl = document.getElementById('predictedPrice');
        const errorMessageEl = document.getElementById('errorMessage');

        function encodeSaleDate(dateString) {
            const baseDate = new Date('2021-01-01');
            const saleDate = new Date(dateString);
            const diffTime = saleDate - baseDate;
            const diffMonths = diffTime / (1000 * 60 * 60 * 24 * 30.44);
            return Math.round(diffMonths);
        }

        function getISOWeek(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        function circleEncodeRatio(value) {
            const angle = 2 * Math.PI * value;
            return [Math.sin(angle), Math.cos(angle)];
        }

        function circleEncodeWeek(dateString) {
            const date = new Date(dateString);
            const week = getISOWeek(date);
            const ratio = (week - 1) / 52;
            return circleEncodeRatio(ratio);
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('en-IE', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price);
        }

        function oneHotEncode(value, possibleValues) {
            return possibleValues.map(v => v === value ? 1 : 0);
        }

        function calculateFutureDate(monthsFromNow) {
            const date = new Date();
            date.setMonth(date.getMonth() + monthsFromNow);
            return date.toISOString().split('T')[0];
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            resultDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');

            const formData = new FormData(form);
            const eircode = formData.get('eircode_routing_key').toUpperCase();
            const bedrooms = parseInt(formData.get('bedrooms'));
            const bathrooms = parseInt(formData.get('bathrooms'));
            const size_m = parseFloat(formData.get('size_m'));
            const building_type = formData.get('building_type');
            const ber_rating = formData.get('ber_rating');
            const months_offset = parseInt(formData.get('sale_date'));
            const sale_date = calculateFutureDate(months_offset);

            const numeric = [bedrooms, bathrooms, size_m];
            const eircode_encoded = oneHotEncode(eircode, FEATURES.eircodes);
            const building_type_encoded = oneHotEncode(building_type, FEATURES.building_types);
            const ber_encoded = oneHotEncode(ber_rating, FEATURES.bers);
            const months_since_epoch = [encodeSaleDate(sale_date)];
            const sale_date_encoded = circleEncodeWeek(sale_date);

            const features = [
                ...numeric,
                ...eircode_encoded,
                ...building_type_encoded,
                ...ber_encoded,
                ...months_since_epoch,
                ...sale_date_encoded
            ];

            try {
                const prediction = score(features);
                predictedPriceEl.textContent = formatPrice(prediction);
                resultDiv.classList.remove('hidden');
            } catch (error) {
                errorMessageEl.textContent = error.message;
                errorDiv.classList.remove('hidden');
                throw error;
            }
        });

        document.getElementById('r2-value').textContent = STATS.testR2.toFixed(3);
        document.getElementById('train-size').textContent = STATS.trainSetSize.toLocaleString('en-IE');
        document.getElementById('r2-percent').textContent = (STATS.testR2 * 100).toFixed(1) + '%';

        const tableBody = document.getElementById('eircodeTableBody');
        STATS.eircodeToImpact.forEach((item, index) => {
            const row = document.createElement('tr');

            const impactValue = item.impact;
            let impactColor = 'text-gray-700';
            let bgColor = '';

            if (impactValue > 0) {
                impactColor = 'text-emerald-600 font-semibold';
                bgColor = 'bg-emerald-50';
            } else if (impactValue < 0) {
                impactColor = 'text-red-600 font-semibold';
                bgColor = 'bg-red-50';
            }

            row.className = bgColor;
            row.innerHTML = `
                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.eircode}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm ${impactColor} text-right">${formatPrice(impactValue)}</td>
            `;

            tableBody.appendChild(row);
        });
    </script>
</body>
</html>
